






<!doctype html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="author" content="WenJunHuang">
  
  
  
  
    <meta name="description" content="1.理解NSObject和元类1.1 在OC中的对象和类是什么
对象是在objc.h中定义的

1234567/// An opaque type that represents an C class.typedef struct objc_class *Class;/// Represents an instance of a class.struct objc_object &#123;...">
  
  <title>Objective-C源码学习 [ HuangXiaoDou's Blog ]</title>
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
  <link rel="stylesheet" href="/css/random.css">
<link rel="stylesheet" href="/css/vegas.min.css">
<link rel="stylesheet" href="/css/highlight-railscasts.css">
<link rel="stylesheet" href="/css/jquery.fancybox.css">
<link rel="stylesheet" href="/css/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/jquery.fancybox-thumbs.css">
<link rel="stylesheet" href="/css/plyr.css">
  
</head>

<body>
<div class="side-navigate hide-area">
  
    <div class="item prev">
      <a href="/2016/10/14/黄小逗爸爸妈妈爱你/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        黄小逗，爸爸妈妈爱你！❤️
      </div>
    </div>
  
  
</div>
<div id="outer-container" class="hide-area">
<div id="container">
  <div id="menu-outer" class="slide-down">
    <div id="menu-inner">
      <div id="brand">
        
        <a onClick="openUserCard()">
          <img id="avatar" src="http://7xqztm.com1.z0.glb.clouddn.com/FullSizeRender.jpg"/>
          <div id="homelink">HuangXiaoDou's Blog</div>
        </a>
      </div>
      <div id="menu-list">
        <ul>
        
        
          
            <li>
          
            <a href="/index.html">首页</a>
            
          </li>
        
          
            <li>
          
            <a href="/archives">文章</a>
            
          </li>
        
          
            <li>
          
            <a href="/tags">标签</a>
            
          </li>
        
          
            <li>
          
            <a href="/categories">分类</a>
            
          </li>
        
          
            <li>
          
            <a href="/about">关于</a>
            
          </li>
        
        </ul>
      </div>
      <div id="animation-menu">
        <svg viewBox="0 0 800 600">
          <path d="M300,220 C300,220 520,220 540,220 C740,220 640,540 520,420 C440,340 300,200 300,200" id="top"></path>
          <path d="M300,320 L540,320" id="middle"></path>
          <path d="M300,210 C300,210 520,210 540,210 C740,210 640,530 520,410 C440,330 300,190 300,190" id="bottom" transform="translate(480, 320) scale(1, -1) translate(-480, -318) "></path>
        </svg>
      </div>
      <!--<div id="show-menu">
        <button>菜单</button>
      </div> -->
    </div>
  </div>

  <div id="content-outer">
    <div id="content-inner">
      
      
  <article id="post">
    <h1>Objective-C源码学习</h1>
    <p class="page-title-sub">
      <span id = "post-title-date">撰写于 2016-09-14</span>
      
        <span id = "post-title-updated">修改于 2016-10-21</span>
      
      
      <span id = "post-title-categories">分类
      
      
        
        
        <a href="/categories/IOSReverse/">IOSReverse</a>
      
      </span>
      
      
      <span id = "post-title-tags">
      标签
      
      
        
        
        <a href="/tags/IOSReverse/">IOSReverse</a>
      
        
          /
        
        
        <a href="/tags/Objective-C/">Objective-C</a>
      
        
          /
        
        
        <a href="/tags/IOS/">IOS</a>
      
      </span>
      
    </p>
    
    <h2 id="1-理解NSObject和元类"><a href="#1-理解NSObject和元类" class="headerlink" title="1.理解NSObject和元类"></a>1.理解NSObject和元类</h2><h4 id="1-1-在OC中的对象和类是什么"><a href="#1-1-在OC中的对象和类是什么" class="headerlink" title="1.1 在OC中的对象和类是什么"></a>1.1 在OC中的对象和类是什么</h4><ol>
<li>对象是在objc.h中定义的</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// An opaque type that represents an C class.</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</div><div class="line"></div><div class="line"><span class="comment">/// Represents an instance of a class.</span></div><div class="line"><span class="keyword">struct</span> objc_object &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ol>
<li>类是在runtime.h中定义的</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_class &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line"></div><div class="line"><span class="meta">#if !__OBJC2__</span></div><div class="line">    Class super_class                                        OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                                         OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">struct</span> objc_method_list **methodLists                    OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">struct</span> objc_cache *cache                                 OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;</div><div class="line"><span class="meta">#endif</span></div><div class="line"></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div><div class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></div></pre></td></tr></table></figure>
<blockquote>
<p>OC中的类和对象在源码中都是用结构体表示的。<br>本质上类并不是C语言中的类，它也是对象，也是某个类的实例，这个类称之为元类(metaclass)。<br>元类也是对象，也是某个类的实例，这个类叫根元类(root metaclass)。<br>所有元类所属类是同一个根元类。<br>根元类也是元类，所以它所属的类也是根元类，也就是它本身。<br>根元类指的就是根类(rootclass)的元类。<br>在C中有两个根类(rootclass)，一个是NSObject，一个是NSProxy。</p>
</blockquote>
<h4 id="1-2-isa指针和super-Class指针"><a href="#1-2-isa指针和super-Class指针" class="headerlink" title="1.2 isa指针和super_Class指针"></a>1.2 isa指针和super_Class指针</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">                            nil</div><div class="line">                             ^</div><div class="line">                             |</div><div class="line">                             |</div><div class="line">                  isa   (NSObject)      isa                      isa</div><div class="line">rootclass实例   ++++++&gt; rootclass类   ++++++&gt; rootclass元类  &lt;&lt;+++++++</div><div class="line">                             ^   ^             |   ^              +  +</div><div class="line">                             |   |             |   |              +  +</div><div class="line">                             |   ---------------   |              +  +</div><div class="line">                  isa   (FatherClass)   isa                       +  +</div><div class="line">fatherclass实例 ++++++&gt; fatherclass类 ++++++&gt; fatherclass元类 ++++++   +</div><div class="line">                             ^                     ^                 +</div><div class="line">                             |                     |                 +</div><div class="line">                             |                     |                 +</div><div class="line">                  isa   (SubClass)      isa                          +</div><div class="line">subclass实例    ++++++&gt; subclass类    ++++++&gt; subclass元类    ++++++++</div></pre></td></tr></table></figure>
<p><strong>我的理解</strong></p>
<p>rootclass元类实际上是objc_class结构体对象。当创建其subclass元类时，objc内部是将父类结构体中保存的方法，<br>拷贝一份到新创建的objc_class结构提对象，此结构体对象的super_Class指针指向父类，所有子元类的isa指针都<br>指向rootclass的元类(根元类)。根元类的isa指针指向自己。比较特殊的是：<strong>根元类的super_Class指针指向根类。</strong></p>
<p>而元类创建类的时候，类的类方法保存在元类中，实例方法保存在自己的类中。也都是用结构体记录。子类方法的<br>isa指针指向元类，super_class指针父类。根类的super_Class指针为nil。</p>
<p>实例类型是objc_object结构体，只有isa指针，没有super_Class指针。</p>
<h2 id="2-Runtime中常用名词"><a href="#2-Runtime中常用名词" class="headerlink" title="2.Runtime中常用名词"></a>2.Runtime中常用名词</h2><h4 id="2-1-SEL"><a href="#2-1-SEL" class="headerlink" title="2.1 SEL"></a>2.1 SEL</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_selector *SEL;</div></pre></td></tr></table></figure>
<blockquote>
<p>源码中没能直接找到objc_selector的定义，但是从书籍是了解到可以将SEL理解为char*指针。<br>如果我们包含函数<code>-(int)test{return 1;}</code>，然后打印<code>NSLog(@&quot;SEL = %s&quot;,@selector(test));</code><br>我们将会得到输出是:<code>SEL = test</code><br>所以猜测<code>struct objc_selector</code>的定义为：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_selector &#123;</div><div class="line">    <span class="keyword">char</span> name[<span class="number">64</span> or ...]</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>它是objc_msgSend函数的第二个参数。在OC中用<code>selector</code>表示(Swift中是<code>Selector</code>类)<br>获取SEL方法选择器：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//使用Objc编译器命令@selector</span></div><div class="line">SEL sel = <span class="keyword">@selector</span>(whatMethod)</div><div class="line"></div><div class="line"><span class="comment">//使用Runtime系统的sel_registerName函数</span></div><div class="line">SEL sel = sel_registerName(<span class="string">"whatMethod"</span>)</div><div class="line"></div><div class="line"><span class="comment">//使用OC方法</span></div><div class="line">SEL sel = <span class="built_in">NSSelectorFromString</span>(<span class="string">@"whatMethod"</span>)</div></pre></td></tr></table></figure>
<h4 id="2-2-id"><a href="#2-2-id" class="headerlink" title="2.2 id"></a>2.2 id</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</div></pre></td></tr></table></figure>
<h4 id="2-3-IMP"><a href="#2-3-IMP" class="headerlink" title="2.3 IMP"></a>2.3 IMP</h4><p>smalltalk是动态语言的鼻祖，更是OC发展的最大推动力。在smalltalk中，所有的东西都是对象（或者都应该被当做对象），例如表达式2 + 3被理解成向对象2发送了消息+，其中接收的参数是 3</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">id</span> (*IMP)(<span class="keyword">id</span>, SEL, ...);</div></pre></td></tr></table></figure>
<blockquote>
<p>它就是一个函数指针，是有编译器生成的。指向了方法的实现。<br><code>IMP</code>跟<code>block</code>是非常相似的东西，<code>IMP</code>可以看做是一个特殊的<code>block</code>，同样的系统提供了两者相互转换的方法：<code>imp_implementationWithBlock</code>和<code>imp_getBlock</code>。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">void</span>)initialize</div><div class="line">    <span class="keyword">void</span> (^requestBlock)(<span class="keyword">id</span> object, SEL aSelector, <span class="keyword">id</span> URL, <span class="keyword">id</span> parameters) = </div><div class="line">        ^(<span class="keyword">id</span> object, SEL aSelector, <span class="keyword">id</span> URL, <span class="keyword">id</span> parameters) &#123;</div><div class="line">        <span class="comment">// do some networking request</span></div><div class="line">    &#125;;</div><div class="line">    IMP requestIMP = imp_implementationWithBlock(requestBlock);</div><div class="line">    class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(networkReuqest:parameters:), requestIMP, <span class="string">"v@:@@"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// View controller</span></div><div class="line">[<span class="keyword">self</span> performSelector: <span class="keyword">@selector</span>(networkReuqest:parameters:) withObject: URL withObject: parameters];</div></pre></td></tr></table></figure>
<p>上面这段代码会crash的非常无厘头，提示EXC_BAD_ACCESS错误。因为block参数不能存在SEL!!去掉<code>SEL aSelector</code>这个参数就OK了。</p>
<h4 id="2-4-Method"><a href="#2-4-Method" class="headerlink" title="2.4 Method"></a>2.4 Method</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_method *Method;</div></pre></td></tr></table></figure>
<blockquote>
<p>在<code>objc_method</code>中存储了方法名，方法类型和方法实现。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">method_name: 方法的名字，通常我们使用@selector()的方式获取一个方法的SEL地址，这个被用来进行散列计算存储方法的IMP实现。由于SEL类型采用了散列的算法，因此如果同一个类中存在同样名字的方法，那么就会导致方法的IMP地址无法唯一化。这也是苹果不允许同名不同参数类型的方法存在的原因。</div><div class="line">method_type: 每一种数据类型有着自己对应的字符编码，method_type表示方法返回值、参数的字符编码，比如-(void)playWith:(id)的字符编码为v@:@。</div><div class="line">*/</div><div class="line"><span class="keyword">struct</span> objc_method &#123;</div><div class="line">    SEL method_name                                          OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">char</span> *method_types                                       OBJC2_UNAVAILABLE;</div><div class="line">    IMP method_imp                                           OBJC2_UNAVAILABLE;</div><div class="line">&#125;                                                            OBJC2_UNAVAILABLE;</div></pre></td></tr></table></figure>
<h4 id="2-5-Ivar"><a href="#2-5-Ivar" class="headerlink" title="2.5 Ivar"></a>2.5 Ivar</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_ivar *Ivar;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>Ivar</code>代表类中的实例变量。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_ivar &#123;</div><div class="line">    <span class="keyword">char</span> *ivar_name                                          OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">char</span> *ivar_type                                          OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">int</span> ivar_offset                                          OBJC2_UNAVAILABLE;</div><div class="line"><span class="meta">#ifdef __LP64__</span></div><div class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125;                                                            OBJC2_UNAVAILABLE;</div></pre></td></tr></table></figure>
<h4 id="2-6-Property"><a href="#2-6-Property" class="headerlink" title="2.6 Property"></a>2.6 Property</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *Property;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t;<span class="comment">//这个更常用</span></div></pre></td></tr></table></figure>
<blockquote>
<p><code>@property</code>标记了类中的属性，是指向<code>objc_property</code>结构体的指针。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_property &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *attributes;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="2-7-Cache"><a href="#2-7-Cache" class="headerlink" title="2.7 Cache"></a>2.7 Cache</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_cache *Cache</div></pre></td></tr></table></figure>
<blockquote>
<p>Cache为方法调用的性能进行优化。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_cache &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>                 OBJC2_UNAVAILABLE;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied                                    OBJC2_UNAVAILABLE;</div><div class="line">    Method buckets[<span class="number">1</span>]                                        OBJC2_UNAVAILABLE;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="3-Runtime中方法使用"><a href="#3-Runtime中方法使用" class="headerlink" title="3.Runtime中方法使用"></a>3.Runtime中方法使用</h2><h4 id="3-1-交换两个方法实现"><a href="#3-1-交换两个方法实现" class="headerlink" title="3.1 交换两个方法实现"></a>3.1 交换两个方法实现</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取某个类的类方法</span></div><div class="line">Method class_getClassMethod(Class cls , SEL name)</div><div class="line"></div><div class="line"><span class="comment">//获取某个类的实例方法</span></div><div class="line">Method class_getInstanceMethod(Class cls , SEL name)</div><div class="line"></div><div class="line"><span class="comment">//交换两个方法的实现</span></div><div class="line"><span class="keyword">void</span> method_exchangeImplementations(Method m1 , Method m2)</div></pre></td></tr></table></figure>
<p><strong>实例</strong></p>
<p><strong>交换类方法</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Method m1 = class_getClassMethod([SomeClass <span class="keyword">class</span>], <span class="keyword">@selector</span>(method1))</div><div class="line">Method m2 = class_getClassMethod([SomeClass <span class="keyword">class</span>], <span class="keyword">@selector</span>(method2))</div><div class="line"></div><div class="line">method_exchangeImplementations(m1, m2)</div></pre></td></tr></table></figure>
<p><strong>拦截系统方法</strong></p>
<p>1、为UIImage创建分类，自定义xd_imageNamed:用于拦截系统方法。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">UIImage</span> *)xd_imageNamed:(<span class="built_in">NSString</span> *)name &#123;</div><div class="line">    <span class="keyword">double</span> version = [[<span class="built_in">UIDevice</span> currentDevice].systemVersion doubleValue];</div><div class="line">    <span class="keyword">if</span> (version &gt;= <span class="number">7.0</span>) &#123;</div><div class="line">        <span class="comment">// 如果系统版本是7.0以上，使用另外一套文件名结尾是‘_os7’的扁平化图片</span></div><div class="line">        name = [name stringByAppendingString:<span class="string">@"_os7"</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//这里因为系统方法名已经变成我们自定义的方法，所以这里要将实际要调用的</span></div><div class="line">    <span class="comment">//imageNamed:换成我们自定义的方法才能调到系统的imageNamed:</span></div><div class="line">    <span class="keyword">return</span> [<span class="built_in">UIImage</span> xd_imageNamed:name];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2、在分类中重写UIImage的load方法，实现方法交换。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">void</span>)load &#123;</div><div class="line">    <span class="comment">// 获取两个类的类方法</span></div><div class="line">    Method m1 = class_getClassMethod([<span class="built_in">UIImage</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(imageNamed:));</div><div class="line">    Method m2 = class_getClassMethod([<span class="built_in">UIImage</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(xd_imageNamed:));</div><div class="line">    <span class="comment">// 开始交换方法实现</span></div><div class="line">    method_exchangeImplementations(m1, m2);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-2-给分类添加属性"><a href="#3-2-给分类添加属性" class="headerlink" title="3.2 给分类添加属性"></a>3.2 给分类添加属性</h4><blockquote>
<p>在分类中是无法设置属性的，因为在分类声明中写<code>@property</code>只能生成get和set方法的声明，但是<br>无法生成成员变量。如果使用成员变量，比如:</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> _num</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)num &#123;</div><div class="line">    <span class="keyword">return</span> _num;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setnum:(<span class="keyword">int</span>)num &#123;</div><div class="line">    _num = num;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//但是全局变量程序整个执行过程中内存里只有一份，当我创建多个对象</span></div><div class="line"><span class="comment">//修改的都是同一个值。</span></div></pre></td></tr></table></figure>
<p><strong>属性关联</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">将值value和对象object关联起来(将值存储到对象中)</div><div class="line">object : 给哪个对象设置属性</div><div class="line">key    : 用于取出存储值的key，一个属性对应一个key，key可以是char，double，int等。</div><div class="line">value  : 给属性设置的值</div><div class="line">policy : 储存策略(assign，copy，retain)</div><div class="line">*/</div><div class="line"><span class="keyword">void</span> objc_setAssociatedObject(<span class="keyword">id</span> object , <span class="keyword">const</span> <span class="keyword">void</span> *key , <span class="keyword">id</span> value , objc_AssociationPloicy policy)</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">用key取值</div><div class="line">*/</div><div class="line"><span class="keyword">id</span> objc_getAssociatedObject(<span class="keyword">id</span> object , <span class="keyword">const</span> <span class="keyword">void</span> *key)</div></pre></td></tr></table></figure>
<p><strong>举个栗子:</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//.h文件</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>)<span class="built_in">NSString</span> *content;</div><div class="line"></div><div class="line"><span class="comment">//.m文件</span></div><div class="line"></div><div class="line"><span class="keyword">char</span> contentKey;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setContent:(<span class="built_in">NSString</span> *)content &#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;contentKey, content, OBJC_ASSOCIATION_COPY_NONATOMIC);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)content &#123;</div><div class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, &amp;contentKey);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-3-获取类的所以成员变量"><a href="#3-3-获取类的所以成员变量" class="headerlink" title="3.3 获取类的所以成员变量"></a>3.3 获取类的所以成员变量</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">获取类的所有成员变量</div><div class="line">*/</div><div class="line">Ivar *class_copyIvarList(Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">获取成员变量的名字</div><div class="line">*/</div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *ivar_getName(Ivar v)</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">获取成员变量的类型</div><div class="line">*/</div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *ivar_getTypeEndcoding(Ivar v)</div></pre></td></tr></table></figure>
<p><strong>举个栗子:重写归档和解档方法</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//.h</span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Extension</span>)</span></div><div class="line"></div><div class="line">- (<span class="built_in">NSArray</span> *)ignoredNames;</div><div class="line">- (<span class="keyword">void</span>)encode:(<span class="built_in">NSCoder</span> *)aCoder;</div><div class="line">- (<span class="keyword">void</span>)decode:(<span class="built_in">NSCoder</span> *)aDecoder;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//.m</span></div><div class="line"><span class="meta">#import <span class="meta-string">"NSObject+Extension.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Extension</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)decode:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</div><div class="line">    <span class="comment">// 一层层父类往上查找，对父类的属性执行归解档方法</span></div><div class="line">    Class c = <span class="keyword">self</span>.class;</div><div class="line">    <span class="keyword">while</span> (c &amp;&amp;c != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</div><div class="line">        Ivar *ivars = class_copyIvarList(c, &amp;outCount);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</div><div class="line">            Ivar ivar = ivars[i];</div><div class="line">            <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line"></div><div class="line">            <span class="comment">// 如果有实现该方法再去调用</span></div><div class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(ignoredNames)]) &#123;</div><div class="line">                <span class="keyword">if</span> ([[<span class="keyword">self</span> ignoredNames] containsObject:key]) <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">id</span> value = [aDecoder decodeObjectForKey:key];</div><div class="line">            [<span class="keyword">self</span> setValue:value forKey:key];</div><div class="line">        &#125;</div><div class="line">        free(ivars);</div><div class="line">        c = [c superclass];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)encode:(<span class="built_in">NSCoder</span> *)aCoder &#123;</div><div class="line">    <span class="comment">// 一层层父类往上查找，对父类的属性执行归解档方法</span></div><div class="line">    Class c = <span class="keyword">self</span>.class;</div><div class="line">    <span class="keyword">while</span> (c &amp;&amp;c != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</div><div class="line">        Ivar *ivars = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</div><div class="line">            Ivar ivar = ivars[i];</div><div class="line">            <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line"></div><div class="line">            <span class="comment">// 如果有实现该方法再去调用</span></div><div class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(ignoredNames)]) &#123;</div><div class="line">                <span class="keyword">if</span> ([[<span class="keyword">self</span> ignoredNames] containsObject:key]) <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">id</span> value = [<span class="keyword">self</span> valueForKeyPath:key];</div><div class="line">            [aCoder encodeObject:value forKey:key];</div><div class="line">        &#125;</div><div class="line">        free(ivars);</div><div class="line">        c = [c superclass];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 设置需要忽略的属性</span></div><div class="line">- (<span class="built_in">NSArray</span> *)ignoredNames &#123;</div><div class="line">    <span class="keyword">return</span> @[<span class="string">@"bone"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 在系统方法内来调用我们的方法</span></div><div class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</div><div class="line">        [<span class="keyword">self</span> decode:aDecoder];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder &#123;</div><div class="line">    [<span class="keyword">self</span> encode:aCoder];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-4-替换方法实现"><a href="#3-4-替换方法实现" class="headerlink" title="3.4 替换方法实现"></a>3.4 替换方法实现</h4><p>假设现在需要一个圆角按钮，并且保证点击触发事件的范围必须要这个圆之内，那么通过一个UIButton+Runtime的扩展来替换旧有-pointInside:withEvent:方法</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIButton</span>(<span class="title">Runtime</span>)</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> roundTouchEnable;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">void</span> * RoundTouchEnableKey = &amp;RoundTouchEnableKey;</div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIButton</span>(<span class="title">Runtime</span>)</span></div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)roundTouchEnable</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, RoundTouchEnableKey) boolValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRoundTouchEnable: (<span class="built_in">BOOL</span>)roundTouchEnable</div><div class="line">&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, RoundTouchEnableKey, @(roundTouchEnable), OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)replacePointInside: (<span class="built_in">CGPoint</span>)point withEvent: (<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">CGRectGetWidth</span>(<span class="keyword">self</span>.frame) != <span class="built_in">CGRectGetHeight</span>(<span class="keyword">self</span>.frame) </div><div class="line">        || !<span class="keyword">self</span>.roundTouchEnable)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> pointInside: point withEvent: event];</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">CGFloat</span> radius = <span class="built_in">CGRectGetWidth</span>(<span class="keyword">self</span>.frame) / <span class="number">2</span>;</div><div class="line">    <span class="built_in">CGPoint</span> offset = <span class="built_in">CGPointMake</span>(point.x - radius, point.y - radius);</div><div class="line">    <span class="keyword">return</span> sqrt(offset.x * offset.x + offset.y * offset.y) &lt;= radius;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 替换方法实现</span></div><div class="line">+ (<span class="keyword">void</span>)initialize</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> initialize];</div><div class="line">    Method replaceMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(replacePointInside:withEvent:));</div><div class="line">    Method originMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(pointInside:withEvent:));</div><div class="line">    method_setImplementation(originMethod, method_getImplementation(replaceMethod));</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h2 id="4-Runtime消息机制"><a href="#4-Runtime消息机制" class="headerlink" title="4 Runtime消息机制"></a>4 Runtime消息机制</h2><h4 id="4-1-C是一门动态语言"><a href="#4-1-C是一门动态语言" class="headerlink" title="4.1 C是一门动态语言"></a>4.1 C是一门动态语言</h4><ul>
<li>静态语言：在运行前会进行类型判断，类的所有成员、方法都会在编译阶段确定好内存地址。类成员只能访问属于自己的方法和变量，如果方法调用错误，代码无法通过编译，会直接引起编译器报错。因此，静态语言结构规范、便于调试、且可以进行多样的性能优化。常见的静态语言包括java/C++/C等。</li>
<li>动态语言：大部分的判断工作被推迟到运行时进行，类的成员变量、方法地址都在运行时确认。可以在运行时动态的添加类成员、方法等。具有较高的灵活性和可定制性、便于阅读，但方法通常无法进行内联等优化。</li>
</ul>
<blockquote>
<p><code>smalltalk</code>是动态语言的鼻祖，更是OC发展的最大推动力。在<code>smalltalk</code>中，所有的东西都是对象（或者都应该被当做对象），例如表达式<code>5 + 3</code>被理解成向对象5发送了消息+，其中接收的参数是 3。</p>
</blockquote>
<h4 id="4-2-消息发送过程"><a href="#4-2-消息发送过程" class="headerlink" title="4.2 消息发送过程"></a>4.2 消息发送过程</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//无参数</span></div><div class="line">objc_msgSend(receiver, selector)</div><div class="line"><span class="comment">//有参数时</span></div><div class="line">objc_msgSend(receiver, selector, arg1, arg2, ...)</div></pre></td></tr></table></figure>
<h5 id="4-2-1-消息发送总览"><a href="#4-2-1-消息发送总览" class="headerlink" title="4.2.1 消息发送总览"></a>4.2.1 消息发送总览</h5><ol>
<li>检测这个<code>selector</code> 是不是要忽略的。比如 Mac OS X 开发，有了垃圾回收就不理会<code>retain</code>,<code>release</code>这些函数了。</li>
<li>检测这个<code>target</code>是不是<code>nil</code>对象。ObjC的特性是允许对一个<code>nil</code>对象执行任何一个方法不会Crash，因为会被忽略掉。</li>
<li>如果上面两个通过，就从先<code>cache</code>里面找这个类的<code>IMP</code>，找到就直接跳到对应函数里面。</li>
<li>如果<code>cache</code>里面没有，就到类的方法列表中查找，然后超类的方法列表，一直到<code>NSObject</code>。</li>
<li>如果还说没有就要进入<code>动态方法</code>解析了。</li>
</ol>
<blockquote>
<p>为了高度优化性能，苹果直接使用汇编实现了这个函数（源码处于Source/objc-msg-arm.s文件下）：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*****************************************************************</span></div><div class="line"> *</div><div class="line"> * id objc_msgSend(id self, SEL    _cmd,...);</div><div class="line"> *</div><div class="line"> *****************************************************************/</div><div class="line">    ENTRY objc_msgSend</div><div class="line">    MESSENGER_START</div><div class="line"></div><div class="line">    cbz    r0, LNilReceiver_f    <span class="comment">// 判断消息接收者是否为nil</span></div><div class="line"></div><div class="line">    ldr    r9, [r0]              <span class="comment">// r9 = self-&gt;isa</span></div><div class="line">    CacheLookup NORMAL           <span class="comment">// 到缓存中查找方法</span></div><div class="line"></div><div class="line">LCacheMiss:                      <span class="comment">// 方法未缓存</span></div><div class="line">    MESSENGER_END_SLOW</div><div class="line">    ldr    r9, [r0, <span class="meta">#ISA]        </span></div><div class="line">    b    __objc_msgSend_uncached</div><div class="line"></div><div class="line">LNilReceiver:                    <span class="comment">// 消息接收者为nil处理</span></div><div class="line">    mov    r1, <span class="meta">#0</span></div><div class="line">    mov    r2, <span class="meta">#0</span></div><div class="line">    mov    r3, <span class="meta">#0</span></div><div class="line">    FP_RETURN_ZERO</div><div class="line">    MESSENGER_END_NIL</div><div class="line">    bx    lr    </div><div class="line"></div><div class="line">LMsgSendExit:</div><div class="line">    END_ENTRY objc_msgSend</div></pre></td></tr></table></figure>
<h5 id="4-2-2-查找方法"><a href="#4-2-2-查找方法" class="headerlink" title="4.2.2 查找方法"></a>4.2.2 查找方法</h5><blockquote>
<p>查找方法实现是通过_class_lookupMethodAndLoadCache3这个函数完成的：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">IMP _class_lookupMethodAndLoadCache3(<span class="keyword">id</span> obj, SEL sel, Class cls)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> lookUpImpOrForward(cls, sel, obj, </div><div class="line">                          <span class="literal">YES</span><span class="comment">/*initialize*/</span>, <span class="literal">NO</span><span class="comment">/*cache*/</span>, <span class="literal">YES</span><span class="comment">/*resolver*/</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">IMP lookUpImpOrForward(Class cls, SEL sel, <span class="keyword">id</span> inst, </div><div class="line">                   <span class="keyword">bool</span> initialize, <span class="keyword">bool</span> cache, <span class="keyword">bool</span> resolver)</div><div class="line">&#123;</div><div class="line">    Class curClass;</div><div class="line">    IMP methodPC = <span class="literal">nil</span>;</div><div class="line">    Method meth;</div><div class="line">    <span class="keyword">bool</span> triedResolver = <span class="literal">NO</span>;</div><div class="line"></div><div class="line">    methodListLock.assertUnlocked();</div><div class="line"></div><div class="line">    <span class="comment">// 如果传入的cache为YES，到类缓存中查找方法缓存</span></div><div class="line">    <span class="keyword">if</span> (cache) &#123;</div><div class="line">        methodPC = _cache_getImp(cls, sel);</div><div class="line">        <span class="keyword">if</span> (methodPC) <span class="keyword">return</span> methodPC;    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 判断类是否已经被释放</span></div><div class="line">    <span class="keyword">if</span> (cls == _class_getFreedObjectClass())</div><div class="line">        <span class="keyword">return</span> (IMP) _freedHandler;</div><div class="line"></div><div class="line">    <span class="comment">// 如果类未初始化，对其进行初始化。如果这个消息是initialize，那么直接进行类的初始化</span></div><div class="line">    <span class="keyword">if</span> (initialize  &amp;&amp;  !cls-&gt;isInitialized()) &#123;</div><div class="line">        _class_initialize (_class_getNonMetaClass(cls, inst));</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> retry:</div><div class="line">    methodListLock.lock();</div><div class="line"></div><div class="line">    <span class="comment">// 忽略在GC环境下的部分消息，比如retain、release等</span></div><div class="line">    <span class="keyword">if</span> (ignoreSelector(sel)) &#123;</div><div class="line">        methodPC = _cache_addIgnoredEntry(cls, sel);</div><div class="line">        <span class="keyword">goto</span> done;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 遍历缓存方法，如果找到，直接返回</span></div><div class="line">    methodPC = _cache_getImp(cls, sel);</div><div class="line">    <span class="keyword">if</span> (methodPC) <span class="keyword">goto</span> done;</div><div class="line"></div><div class="line">    <span class="comment">// 遍历类自身的方法列表查找方法实现</span></div><div class="line">    meth = _class_getMethodNoSuper_nolock(cls, sel);</div><div class="line">    <span class="keyword">if</span> (meth) &#123;</div><div class="line">        log_and_fill_cache(cls, cls, meth, sel);</div><div class="line">        methodPC = method_getImplementation(meth);</div><div class="line">        <span class="keyword">goto</span> done;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 尝试向上遍历父类的方法列表查找实现</span></div><div class="line">    curClass = cls;</div><div class="line">    <span class="keyword">while</span> ((curClass = curClass-&gt;superclass)) &#123;</div><div class="line">        <span class="comment">// Superclass cache.</span></div><div class="line">        meth = _cache_getMethod(curClass, sel, _objc_msgForward_impcache);</div><div class="line">        <span class="keyword">if</span> (meth) &#123;</div><div class="line">            <span class="keyword">if</span> (meth != (Method)<span class="number">1</span>) &#123; </div><div class="line">                log_and_fill_cache(cls, curClass, meth, sel);</div><div class="line">                methodPC = method_getImplementation(meth);</div><div class="line">                <span class="keyword">goto</span> done;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Found a forward:: entry in a superclass.</span></div><div class="line">                <span class="comment">// Stop searching, but don't cache yet; call method </span></div><div class="line">                <span class="comment">// resolver for this class first.</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 查找父类的方法列表</span></div><div class="line">        meth = _class_getMethodNoSuper_nolock(curClass, sel);</div><div class="line">        <span class="keyword">if</span> (meth) &#123;</div><div class="line">            log_and_fill_cache(cls, curClass, meth, sel);</div><div class="line">            methodPC = method_getImplementation(meth);</div><div class="line">            <span class="keyword">goto</span> done;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 没有找到任何的方法实现，进入消息转发第一阶段“动态方法解析”</span></div><div class="line">    <span class="comment">// 调用+ (BOOL)resolveInstanceMethod: (SEL)selector</span></div><div class="line">    <span class="comment">// 征询接收者所属的类是否能够动态的添加这个未实现的方法来解决问题</span></div><div class="line">    <span class="keyword">if</span> (resolver  &amp;&amp;  !triedResolver) &#123;</div><div class="line">        methodListLock.unlock();</div><div class="line">        _class_resolveMethod(cls, sel, inst);</div><div class="line">        triedResolver = <span class="literal">YES</span>;</div><div class="line">        <span class="keyword">goto</span> retry;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 仍然没有找到方法实现进入消息转发第二阶段“备援接收者”</span></div><div class="line">    <span class="comment">// 先后会调用 -(id)forwardingTargetForSelector: (SEL)selector </span></div><div class="line">    <span class="comment">// 以及 - (void)forwardInvocation: (NSInvocation*)invocation 进行最后的补救</span></div><div class="line">    <span class="comment">// 如果补救未成功抛出消息发送错误异常</span></div><div class="line">    _cache_addForwardEntry(cls, sel);</div><div class="line">    methodPC = _objc_msgForward_impcache;</div><div class="line"></div><div class="line"> done:</div><div class="line">    methodListLock.unlock();</div><div class="line"></div><div class="line">    assert(!(ignoreSelector(sel)  &amp;&amp;  methodPC != (IMP)&amp;_objc_ignored_method));</div><div class="line">    <span class="keyword">return</span> methodPC;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>以上为方法调用全部过程，主要分为三部分：</strong></p>
<p>1、查找是否存在对应方法缓存，如果存在直接返回调用，为了优化性能，方法的缓存使用了散列表的方式。</p>
<p>2、未找到缓存， 到类本身或顺着类结构向上查找方法实现，返回<code>method_t *</code>类型也就是<code>Method</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//非加锁状态下查找方法实现</span></div><div class="line"><span class="keyword">static</span> method_t * getMethodNoSuper_nolock(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line">    assert(cls-&gt;isRealized());</div><div class="line">    <span class="comment">// fixme nil cls? </span></div><div class="line">    <span class="comment">// fixme nil sel?</span></div><div class="line">    <span class="keyword">for</span> (auto mlists = cls-&gt;data()-&gt;methods.beginLists(), </div><div class="line">            end = cls-&gt;data()-&gt;methods.endLists(); </div><div class="line">             mlists != end;</div><div class="line">               ++mlists)</div><div class="line">    &#123;</div><div class="line">        method_t *m = search_method_list(*mlists, sel);</div><div class="line">        <span class="keyword">if</span> (m) <span class="keyword">return</span> m;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 搜索方法列表</span></div><div class="line"><span class="keyword">static</span> method_t * search_method_list(<span class="keyword">const</span> method_list_t *mlist, SEL sel)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> methodListIsFixedUp = mlist-&gt;isFixedUp();</div><div class="line">    <span class="keyword">int</span> methodListHasExpectedSize = mlist-&gt;entsize() == <span class="keyword">sizeof</span>(method_t);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (__builtin_expect(methodListIsFixedUp &amp;&amp; methodListHasExpectedSize, <span class="number">1</span>)) &#123;</div><div class="line">          <span class="comment">// 对有序数组进行线性探测</span></div><div class="line">          <span class="keyword">return</span> findMethodInSortedMethodList(sel, mlist);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Linear search of unsorted method list</span></div><div class="line">        <span class="keyword">for</span> (auto&amp; meth : *mlist) &#123;</div><div class="line">            <span class="keyword">if</span> (meth.name == sel) <span class="keyword">return</span> &amp;meth;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="meta">#if DEBUG</span></div><div class="line">    <span class="comment">// sanity-check negative results</span></div><div class="line">    <span class="keyword">if</span> (mlist-&gt;isFixedUp()) &#123;</div><div class="line">        <span class="keyword">for</span> (auto&amp; meth : *mlist) &#123;</div><div class="line">            <span class="keyword">if</span> (meth.name == sel) &#123;</div><div class="line">                _objc_fatal(<span class="string">"linear search worked when binary search did not"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果在这步骤中找到方法实现，则将它加入方法缓存中。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 记录并且缓存方法</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> log_and_fill_cache(Class cls, IMP imp, SEL sel, <span class="keyword">id</span> receiver, Class implementer)</div><div class="line">&#123;</div><div class="line"><span class="meta">#if SUPPORT_MESSAGE_LOGGING</span></div><div class="line">    <span class="keyword">if</span> (objcMsgLogEnabled) &#123;</div><div class="line">        <span class="keyword">bool</span> cacheIt = logMessageSend(implementer-&gt;isMetaClass(), </div><div class="line">                                cls-&gt;nameForLogging(),</div><div class="line">                                implementer-&gt;nameForLogging(), </div><div class="line">                                sel);</div><div class="line">        <span class="keyword">if</span> (!cacheIt) <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line">    cache_fill (cls, sel, imp, receiver);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//在无加锁状态下缓存方法</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> cache_fill_nolock(Class cls, SEL sel, IMP imp, <span class="keyword">id</span> receiver)</div><div class="line">&#123;</div><div class="line">    cacheUpdateLock.assertLocked();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!cls-&gt;isInitialized()) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (cache_getImp(cls, sel)) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    cache_t *cache = getCache(cls);</div><div class="line">    cache_key_t key = getKey(sel);</div><div class="line"></div><div class="line">    <span class="comment">// 如果缓存占用不到3/4，进行缓存。</span></div><div class="line">    mask_t newOccupied = cache-&gt;occupied() + <span class="number">1</span>;</div><div class="line">    mask_t capacity = cache-&gt;capacity();</div><div class="line">    <span class="keyword">if</span> (cache-&gt;isConstantEmptyCache()) &#123;</div><div class="line">        cache-&gt;reallocate(capacity, capacity ?: INIT_CACHE_SIZE);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (newOccupied &lt;= capacity / <span class="number">4</span> * <span class="number">3</span>) &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 扩充缓存。为了性能，扩充后原有缓存方法全部移除</span></div><div class="line">        cache-&gt;expand();</div><div class="line">    &#125;</div><div class="line">    bucket_t *bucket = cache-&gt;find(key, receiver);</div><div class="line">    <span class="keyword">if</span> (bucket-&gt;key() == <span class="number">0</span>) cache-&gt;incrementOccupied();</div><div class="line">    bucket-&gt;set(key, imp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果在类自身方法中没找到，那么循环父类方法，重复上面动作。</p>
<p>3、如果未找到任何方法实现，则会出发消息转发机制。</p>
<blockquote>
<p>消息转发分为两个阶段，第一个阶段我们可以通过动态添加方法之后让编译器再次执行查找方法实现的过程；第二个阶段称作备援的接收者，就是找到一个接盘侠来处理这个事件。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> _class_resolveMethod(Class cls, SEL sel, <span class="keyword">id</span> inst)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// 非beta类的情况下直接调用 resolveInstanceMethod 方法</span></div><div class="line">    <span class="keyword">if</span> (! cls-&gt;isMetaClass()) &#123;</div><div class="line">        _class_resolveInstanceMethod(cls, sel, inst);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 先调用 resolveClassMethod 请求动态添加方法</span></div><div class="line">        <span class="comment">// 然后进行一次查找判断是否处理完成</span></div><div class="line">        <span class="comment">// 如果没有添加，再调用 resolveInstanceMethod 方法</span></div><div class="line">        _class_resolveClassMethod(cls, sel, inst);</div><div class="line">        <span class="keyword">if</span> (!lookUpImpOrNil(cls, sel, inst, </div><div class="line">                      <span class="literal">NO</span><span class="comment">/*initialize*/</span>, <span class="literal">YES</span><span class="comment">/*cache*/</span>, <span class="literal">NO</span><span class="comment">/*resolver*/</span>)) </div><div class="line">        &#123;</div><div class="line">            _class_resolveInstanceMethod(cls, sel, inst);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="4-2-3-方法缓存"><a href="#4-2-3-方法缓存" class="headerlink" title="4.2.3 方法缓存"></a>4.2.3 方法缓存</h5><blockquote>
<p><code>cache</code>存储着我们在方法调用中需要查找的方法缓存。作为缓存方法的cache采用了散列表，以此来大幅度提高检索的速度：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define CACHE_HASH(sel, mask) (((uintptr_t)(sel)&gt;&gt;2) &amp; (mask))</span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> cache_t &#123;</div><div class="line">    <span class="keyword">struct</span> bucket_t *_buckets;</div><div class="line">    mask_t _mask;</div><div class="line">    mask_t _occupied;</div><div class="line">    <span class="comment">// functions</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// cache method</span></div><div class="line">buckets = (cache_entry **)cache-&gt;buckets;</div><div class="line"><span class="keyword">for</span> (index = <span class="built_in">CACHE_HASH</span>(sel, cache-&gt;mask); </div><div class="line">     buckets[index] != <span class="literal">NULL</span>; </div><div class="line">     index = (index+<span class="number">1</span>) &amp; cache-&gt;mask)</div><div class="line">&#123; &#125;</div><div class="line">buckets[index] = entry;</div><div class="line"></div><div class="line"><span class="comment">//利用sel的指针地址和mask做一个简单的位运算，然后找到一个空槽存储起来。</span></div></pre></td></tr></table></figure>
<blockquote>
<p>以此推出从缓存中查找sel实现代码CacheLookup, 苹果使用汇编完成查找步骤，用以优化性能。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">.macro CacheLookup</div><div class="line"></div><div class="line">    ldrh    r12, [r9, <span class="meta">#CACHE_MASK]    // r12 = mask</span></div><div class="line">    ldr    r9, [r9, <span class="meta">#CACHE]    // r9 = buckets</span></div><div class="line">.if $<span class="number">0</span> == STRET  ||  $<span class="number">0</span> == SUPER_STRET</div><div class="line">    and    r12, r12, r2        <span class="comment">// r12 = index = SEL &amp; mask</span></div><div class="line">.else</div><div class="line">    and    r12, r12, r1        <span class="comment">// r12 = index = SEL &amp; mask</span></div><div class="line">.endif</div><div class="line">    add    r9, r9, r12, LSL <span class="meta">#3    // r9 = bucket = buckets+index*8</span></div><div class="line">    ldr    r12, [r9]        <span class="comment">// r12 = bucket-&gt;sel</span></div><div class="line"><span class="number">2</span>:</div><div class="line">.if $<span class="number">0</span> == STRET  ||  $<span class="number">0</span> == SUPER_STRET</div><div class="line">    teq    r12, r2</div><div class="line">.else</div><div class="line">    teq    r12, r1</div><div class="line">.endif</div><div class="line">    bne    <span class="number">1</span>f</div><div class="line">    CacheHit $<span class="number">0</span></div><div class="line"><span class="number">1</span>:    </div><div class="line">    cmp    r12, <span class="meta">#1</span></div><div class="line">    blo    LCacheMiss_f        <span class="comment">// if (bucket-&gt;sel == 0) cache miss</span></div><div class="line">    it    eq            <span class="comment">// if (bucket-&gt;sel == 1) cache wrap</span></div><div class="line">    ldreq    r9, [r9, <span class="meta">#4]        // bucket-&gt;imp is before first bucket</span></div><div class="line">    ldr    r12, [r9, <span class="meta">#8]!        // r12 = (++bucket)-&gt;sel</span></div><div class="line">    b    <span class="number">2</span>b</div><div class="line"></div><div class="line">.endmacro</div></pre></td></tr></table></figure>
<h4 id="4-3-消息转发"><a href="#4-3-消息转发" class="headerlink" title="4.3 消息转发"></a>4.3 消息转发</h4><blockquote>
<p>通常情况下，调用不属于某个对象的方法的时候，应用就会崩溃crash。<br>通过方法调用源码可以看到，并不是没有找到方法实现就直接crash。<br>在crash之前编译器会进行消息转发机制，有依次有三次机会。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">第一阶段         resolveInstanceMethod  </div><div class="line">(动态添加方法：添加对应方法，跳到方法实现)             </div><div class="line">						   </div><div class="line">第二阶段		 forwardingTargetForSelector</div><div class="line">(最后的接盘侠：直接接管对应方法，实现方法)</div><div class="line"></div><div class="line">			     forwardInvocation</div></pre></td></tr></table></figure>
<p>1、第一阶段(resolveInstanceMethod)</p>
<p>避免程序因为类型错误导致crash，可以通过<code>class_addMethod</code>动态添加处理方法。<br>类可以在<code>objc_registerClassPair</code>完成类注册后动态添加方法，但不能动态添加属性，<br>类似于<code>category</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> wrongTypeGetter(<span class="keyword">id</span> object, SEL sel) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> wrongTypeSetter(<span class="keyword">id</span> object, SEL sel, <span class="keyword">id</span> value) &#123;</div><div class="line">    <span class="comment">// do nothing</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod: (SEL)selector</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> * selName = <span class="built_in">NSStringFromSelector</span>(selector);</div><div class="line">    <span class="keyword">if</span> ([sel hasPrefix: <span class="string">@"set"</span>]) &#123;</div><div class="line">        class_addMethod(<span class="keyword">self</span>, selector, (IMP)wrongTypeSetter, <span class="string">"v@:@"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        class_addMethod(<span class="keyword">self</span>, selector, (IMP)wrongTypeGetter, <span class="string">"@@:"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2、第二阶段(forwardingTargetForSelector)</p>
<blockquote>
<p>在iOS中不支持多继承，尽管我们可以通过协议和组合模式实现<code>伪多继承</code>。<code>伪多继承</code>和<code>多继承</code>的区别在于：<code>多继承</code>是将多个类的功能组合到一个对象当中，而<code>伪多继承</code>多个类的功能依旧分布在不同对象当中，但是对象彼此对消息发送者透明。那么，如果我们消息转发给另一个对象可以用来实现这种伪多继承。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>: <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSNumber</span> * age;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector: (SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="comment">// 甚至可以通过runtime遍历自己属性找到可以响应方法的接盘侠</span></div><div class="line">    <span class="built_in">NSString</span> * selName = <span class="built_in">NSStringFromSelector</span>(aSelector);</div><div class="line">    <span class="keyword">if</span> ([selName hasSuffix: <span class="string">@"Value"</span>]) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.age;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// View controller</span></div><div class="line"><span class="keyword">id</span> p = [[Person alloc] init];</div><div class="line">[p setAge: @(<span class="number">18</span>)];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%lu, %.2f"</span>, [p integerValue], [p doubleValue]);    <span class="comment">//18, 18.00</span></div></pre></td></tr></table></figure>
<p>3、第二阶段最后(forwardInvocation)</p>
<blockquote>
<p><code>runtime</code>需要生成一个<code>methodSignature</code>变量来组装，这将通过调用消息接收者的<code>-(NSMethodSignature *)methodSignatureForSelector:</code>获取，这个变量包含了方法的参数类型、参数个数以及消息接收者等信息。接着把这个变量组装成一个NSInvocation对象进行最后一次的消息转发，调用接收者的<code>-forwardInvocation:</code>方法。我们可以对<code>invocation</code>做任何事情，包括随意修改参数值、消息接收者等。我最常拿来干的事情就是减少数组的遍历工作：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSArray</span>(<span class="title">Runtime</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation: (<span class="built_in">NSInvocation</span> *)anInvocation</div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> item <span class="keyword">in</span> <span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">if</span> ([item respondsToSelector: anInvocation.selector]) &#123;</div><div class="line">            [anInvocation invokeWithTarget: item];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>NSInvocation对象封装了动态库向接收器转发执行消息所需的所有必要信息，如目标对象、方法选择器、方法参数。因此可以借助NSInvocation实例，使用内部的选择器和其他信息，在任何时候调用接收器。同一个NSInvocation实例可重复调用接收器的同一个方法，或通过不同的目标和方法签名进行复用。<br>OC中直接调用对象的消息方法有两种：<br>1.<code>performSelector:withObject</code><br>2.NSInvocation<br>实现NSArray的map方法。可以让数组中每个元素接受消息，并且返回一个新的数组。该方法类似于<code>makeObjectsPerformSelector:</code>，不同的是map可以传送带有多个参数的消息，而且可以延伸至数组以外的集合。比如:</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">	NSArray *testArray = @[@1, @2, @3];</div><div class="line">	id stringArray = [[testArray map] stringValue];</div><div class="line">	NSLog(@%@", stringArray); // "1", "2", "3"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>实现代码</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//NSArray+Map.h</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArray</span> (<span class="title">Map</span>)</span></div><div class="line">- (<span class="keyword">id</span>)map;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//NSArray+Map.m</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSArray</span> (<span class="title">Map</span>)</span></div><div class="line">- (<span class="keyword">id</span>)map &#123;</div><div class="line">	<span class="keyword">return</span> [[<span class="built_in">NSArrayMapProxy</span> alloc] initWithArray:<span class="keyword">self</span>];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//实现NSArrayMapProxy</span></div><div class="line"><span class="comment">//NSArrayMapProxy.h</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArrayMapProxy</span> : <span class="title">NSProxy</span> </span>&#123;</div><div class="line">	<span class="built_in">NSArray</span> *_array;</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">instancetype</span>)initWithArray:(<span class="built_in">NSArray</span> *)array;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//NSArrayMapProxy.m</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSArrayMapProxy</span> </span></div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithArray:(<span class="built_in">NSArray</span> *)array &#123;</div><div class="line">	_array = array;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//示例中的数组array包含三个NSNumber类型的对象，于是向proxy发送stringValue消息的时候，proxy就负责将消息转发给数组中的每个元素。于是NSArrayMapProxy就需要重载NSProxy的两个方法，来实现消息转发机制。</span></div><div class="line"><span class="comment">//1.在NSArrayMapProxy收到消息后，首先methodSignatureForSelector:会被调用，用于返回一个方法签名。</span></div><div class="line"></div><div class="line"><span class="comment">//这里重载方法时，遍历数组中的元素，如果有元素响应消息，就可以通过该元素找到消息的方法签名。</span></div><div class="line"><span class="comment">//这个函数也就是找到方法的实现，自己没有实现方法，就到别的对象中找。</span></div><div class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)sel &#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> _array) &#123;</div><div class="line">		<span class="keyword">if</span> ([obj respondsToSelector:sel]) &#123;</div><div class="line">			<span class="keyword">return</span> [obj methodSignatureForSelector:sel];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:sel];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//2.在得到方法签名之后，接着会调`forwardInvocation:`方法，于是可以重载方法后在这里决定消息的转发去向。</span></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</div><div class="line">	SEL sel = invocation.selector;</div><div class="line">	<span class="built_in">NSMutableArray</span> *mappedArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:_array.count];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> _array) &#123;</div><div class="line">		<span class="keyword">if</span> ([obj respondsToSelector:sel]) &#123;</div><div class="line">			<span class="comment">//[NSInvocation invoke]方法调用</span></div><div class="line">			[invocation invokeWithTarget:obj]; <span class="comment">//调用数组中元素obj的stringValue方法</span></div><div class="line">			<span class="keyword">id</span> mappedValue; <span class="comment">//用于存储调用返回value</span></div><div class="line">			[invocation getReturnValue:&amp;mappedValue];</div><div class="line">			[mappedArray addObject:mapped];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//设置调用[NSArrayMapProxy stringValue]的返回值</span></div><div class="line">	[invocation setReturnValue:&amp;mappedArray];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>具体思路：为NSArray添加map方法，当调用map方式时，返回的是NSArrayMapProxy对象。之后调用NSArrayMapProxy对象的stringValue方法。<br>NSArrayMapProxy对象的作用就是在NSArray元素中找到sel方法的签名(就是得到stringValue的实现方法)，然后让每个元素都调用这个方法，并将返回值存储起来，得到新的NSArray。</p>
</blockquote>
<p>还有利用类似思路解决服务器返回NSNull问题。</p>

  </article>
  <div class="random-toc-area">
  <button class="btn-hide-toc btn-hide-toc-show" style="display: none" onclick="TOCToggle()">显示目录</button>
  <button class="btn-hide-toc btn-hide-toc-hide" onclick="TOCToggle()">隐藏目录</button>
  <div class="random-toc">
    <h2>目录</h2>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-理解NSObject和元类"><span class="toc-text">1.理解NSObject和元类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-在OC中的对象和类是什么"><span class="toc-text">1.1 在OC中的对象和类是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-isa指针和super-Class指针"><span class="toc-text">1.2 isa指针和super_Class指针</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Runtime中常用名词"><span class="toc-text">2.Runtime中常用名词</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-SEL"><span class="toc-text">2.1 SEL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-id"><span class="toc-text">2.2 id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-IMP"><span class="toc-text">2.3 IMP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-Method"><span class="toc-text">2.4 Method</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-Ivar"><span class="toc-text">2.5 Ivar</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-Property"><span class="toc-text">2.6 Property</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-Cache"><span class="toc-text">2.7 Cache</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Runtime中方法使用"><span class="toc-text">3.Runtime中方法使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-交换两个方法实现"><span class="toc-text">3.1 交换两个方法实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-给分类添加属性"><span class="toc-text">3.2 给分类添加属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-获取类的所以成员变量"><span class="toc-text">3.3 获取类的所以成员变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-替换方法实现"><span class="toc-text">3.4 替换方法实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Runtime消息机制"><span class="toc-text">4 Runtime消息机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-C是一门动态语言"><span class="toc-text">4.1 C是一门动态语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-消息发送过程"><span class="toc-text">4.2 消息发送过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-消息发送总览"><span class="toc-text">4.2.1 消息发送总览</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-查找方法"><span class="toc-text">4.2.2 查找方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3-方法缓存"><span class="toc-text">4.2.3 方法缓存</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-消息转发"><span class="toc-text">4.3 消息转发</span></a></li></ol></li></ol></li></ol>
  </div>
</div>

  
<nav id="pagination">
  
    <a href="/2016/10/14/黄小逗爸爸妈妈爱你/" class="prev">&larr; 上一篇 黄小逗，爸爸妈妈爱你！❤️</a>
  

  

  
</nav>

  <!-- JiaThis Button BEGIN -->

<!-- JiaThis Button END -->


      
      
      
    </div>
  </div>

  <div id="bottom-outer">
    <div id="bottom-inner">
      ©2016,Site by <a href="http://weibo.com/kongkongss">WenJunHuang</a> using Hexo
      <br>
      
    </div>
  </div>
</div>

</div>



<div id="user-card">
  <div class="center-field">
    <img class="avatar" src="http://7xqztm.com1.z0.glb.clouddn.com/FullSizeRender.jpg">
    <p id="description">技术分享，生活记录</p>
    <ul class="social-icon">
  
  
    <li>
      <a href="https://github.com/aliyoge">
        
          <i class="icon iconfont github">&#xe606;</i>
        
      </a>
    </li>
  
    <li>
      <a href="http://weibo.com/kongkongss">
        
          <i class="icon iconfont weibo">&#xe602;</i>
        
      </a>
    </li>
  
    <li>
      <a href="https://twitter.com/WenjunHuang">
        
          <i class="icon iconfont twitter">&#xe600;</i>
        
      </a>
    </li>
  
    <li>
      <a href="https://www.facebook.com/wenjun.huang.129">
        
          <i class="icon iconfont facebook">&#xe604;</i>
        
      </a>
    </li>
  
</ul>
  </div>
</div>


<div id="btn-view">Hide</div>

<script>
// is trigger analytics / tongji script
var isIgnoreHost = false;

if(window && window.location && window.location.host) {
  isIgnoreHost = ["localhost","127.0.0.1"].some(function(address){
    return 0 === window.location.host.indexOf(address);
  });
}

var isTriggerAnalytics = !( true && isIgnoreHost );

</script>




  
  
    <script src="/js/jquery-2.2.3.min.js"></script>
  
    <script src="/js/vegas.min.js"></script>
  
    <script src="/js/random.js"></script>
  
    <script src="/js/highlight.pack.js"></script>
  
    <script src="/js/jquery.mousewheel.pack.js"></script>
  
    <script src="/js/jquery.fancybox.pack.js"></script>
  
    <script src="/js/jquery.fancybox-thumbs.js"></script>
  
    <script src="/js/plyr.js"></script>
  

<script>

  // fancybox
  var backgroundImages = [];
  
    
      backgroundImages.push('http://7xqztm.com1.z0.glb.clouddn.com/1.jpg?imageView2/1/w/__width__/h/__height__');
    
      backgroundImages.push('http://7xqztm.com1.z0.glb.clouddn.com/bgimg_1.jpg?imageView2/1/w/__width__/h/__height__');
    
      backgroundImages.push('http://7xqztm.com1.z0.glb.clouddn.com/2.jpg?imageView2/1/w/__width__/h/__height__');
    
      backgroundImages.push('http://7xqztm.com1.z0.glb.clouddn.com/1007.jpg?imageView2/1/w/__width__/h/__height__');
    
      backgroundImages.push('http://7xqztm.com1.z0.glb.clouddn.com/2Q==.jpg?imageView2/1/w/__width__/h/__height__');
    
      backgroundImages.push('http://7xqztm.com1.z0.glb.clouddn.com/631283.jpg?imageView2/1/w/__width__/h/__height__');
    
  
  $('#post').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox') || $(this).parent().hasClass('fancybox-thumb')) return;
      var alt = this.alt || this.title;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'post' + i);
    });
  });
  $(".fancybox").fancybox();

var vegasConfig = {"preload­Image":true,"transition":["slideLeft2","slideRight2","flash2"],"timer":true,"delay":5000,"shuffle":false,"count":28};
var unsplashConfig = {"gravity":"north"};
// is show background images
var turnoffBackgroundImage = false;



  turnoffBackgroundImage = true;


var backgroundColor = "E5E5E5";

$(".fancybox-thumb").fancybox({
  prevEffect: 'none',
  nextEffect: 'none',
  helpers: {
    title: {
      type: 'outside'
    },
    thumbs: {
      width: 50,
      height: 50
    }
  }
});

// show video with plyr
$(".video-container iframe").each(function(i){
  var url = $(this).attr('src');
  var id = url.split('/').pop();
  var plyrContainer = document.createElement('div');
  plyrContainer.className = 'plyr';
  var plyrElement = document.createElement('div');
  plyrElement.dataset.videoId = id;
  switch(true) {
    case url.search('youtube.com') >= 0:
      plyrElement.dataset.type = 'youtube';
      break;
    case url.search('vimeo.com') >= 0:
      plyrElement.dataset.type = 'vimeo';
      break;
    default:
      return;
  };
  plyrContainer.appendChild(plyrElement);
  $(this).parent().html(plyrContainer);
});
plyr.setup('.plyr', {iconUrl: '/css/sprite.svg'});
</script>
</body>
</html>

